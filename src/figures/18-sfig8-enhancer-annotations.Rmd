---
title: "sfig 8: BPNet motifs annotated across mm10 mESC enhancers"
author: "Melanie (1028-02098-001-001)"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document:
    depth: 3
    theme: sandstone
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
  word_document:
    toc: yes
header-includes:
- \usepackage{fancyhdr}
- \usepackage{lipsum}
- \pagestyle{fancy}
- \fancyfoot[CO,CE]{1028-02098-001-001}
- \fancyfoot[LE,RO]{\thepage}
- \fancypagestyle{plain}{\pagestyle{fancy}}
editor_options:
  chunk_output_type: console
---

# Introduction

We will annotate the list of BPNet candidate enhancers with the mapped motif instances generated by BPNet and TF-MoDISco.

# Computational Setup

```{r, warning=F, message=F}
#Standard packages
library(rtracklayer) ; library(GenomicRanges); library(magrittr) ; library(Biostrings)
library(ggplot2) ; library(reshape2); library(Rsamtools); library(data.table); library(dplyr)
library(BSgenome.Dmelanogaster.UCSC.dm6); library(viridis)


#KNITR Options
setwd("/n/projects/mw2098/publications/2019_bpnet/")
options(knitr.figure_dir="figures/18-sfig8-enhancer-annotations", width=16, height=12)

#Lab sources
source("/n/projects/mw2098/shared_code/rscripts/granges_common.r")
source("/n/projects/mw2098/shared_code/rscripts/metapeak_common.r")
source("/n/projects/mw2098/shared_code/rscripts/knitr_common.r")
source("/n/projects/mw2098/shared_code/rscripts/caching.r")
source("/n/projects/mw2098/shared_code/custom/metapeak_functions.R")
source("/n/projects/mw2098/shared_code/rscripts/multiplot.R")

#Special sources
library(stringr)
library(grid)
library(gridExtra)
library(readxl)
library(colorspace)
library(ggfittext)
library(readr)

motifs.list<-list(`Oct4-Sox2` = "Oct4/m0_p0", 
                  Oct4 = "Oct4/m0_p1",
                  `Oct4-Oct4` = "Oct4/m0_p6", 
                  Sox2 = "Sox2/m0_p1",
                  Nanog = "Nanog/m0_p1",
                  `Nanog-alt` = "Nanog/m0_p4",
                  Klf4 = "Klf4/m0_p0",
                  `Klf4-long` = "Klf4/m0_p5",
                  `B-box` = "Sox2/m0_p1",
                  Zic3 = "Oct4/m0_p5",
                  Esrrb = "Oct4/m0_p16")
```

# Define annotation paths

```{r}
enhancers.path<-"data/xlsx/enhancer_regions_formatted_v3.xlsx" #curated set of enhancers in mESCs
instances.path<-"data/tsv/dfi_subset.tsv" #all CWM-mapped instances from BPNet/TF-MoDISco run

```

# Prepare enhancer regions

```{r}
#Import and isolate coordinates
enhancers.df<-read_xlsx(enhancers.path)
enhancers.df$mm10_chr<-enhancers.df$mm10_coordinates_curated %>% strsplit(., split = ":") %>% lapply(., function(x) x[1]) %>% unlist 
enhancers.df$mm10_start<-enhancers.df$mm10_coordinates_curated %>% strsplit(., split = ":") %>% lapply(., function(x) x[2]) %>% unlist %>% strsplit(., split = "-") %>% lapply(., function(x) x[1]) %>% as.integer
enhancers.df$mm10_end<-enhancers.df$mm10_coordinates_curated %>% strsplit(., split = "-") %>% lapply(., function(x) x[2]) %>% unlist %>% as.integer
enhancers.df$mm10_strand<-"*"
enhancers.df$enhancer_name<-enhancers.df$name

#Convert to GRanges
enhancers.gr<-enhancers.df %>% makeGRangesFromDataFrame(., keep.extra.columns = T, starts.in.df.are.0based = T, 
                                                        seqnames.field = "mm10_chr", start.field = "mm10_start", 
                                                        end.field = "mm10_end", strand.field = "mm10_strand")


#Validate that enhancer names are unique for identifiers
(enhancers.gr$name %>% length) == (enhancers.gr$name %>% unique() %>% length)

#Record longest enhancer(for plotting over same axis)
enh_longest<-max(width(enhancers.gr))

```

# Map motifs across enhancers

## Import 11 representative instances

```{r}
instances.gr<-readr::read_tsv(instances.path) %>% 
  makeGRangesFromDataFrame(keep.extra.columns = T, starts.in.df.are.0based = T,
                           start.field = "pattern_start_abs", end.field = "pattern_end_abs", seqnames.field = "example_chrom")
instances.gr$pattern_name<-factor(instances.gr$pattern_name, labels = names(motifs.list),
                          levels = c("Oct4-Sox2", "Oct4", "Oct4-Oct4", "Sox2", "Nanog", 
                                     "Nanog-partner", "Klf4", "Klf4-Klf4", "B-Box", "Zic3", "Essrb"))

#query: motif to retain, subject: motif to remove
instances.gr$instance_id<-1:length(instances.gr) #assign identifier for filtering
minoverlap <- 0 #minoverlap can account for looser overlaps for ACAA, GCAT. We don't care about removal of anything on flanks. Minoverlap = 4 returns almost identical results.
o_across_os<-subsetByOverlaps(subset(instances.gr, pattern_name == "Oct4"), subset(instances.gr, pattern_name == "Oct4-Sox2"), ignore.strand = T, minoverlap = minoverlap) 
s_across_os<-subsetByOverlaps(subset(instances.gr, pattern_name == "Sox2"), subset(instances.gr, pattern_name == "Oct4-Sox2"), ignore.strand = T, minoverlap = minoverlap)
o_across_oo<-subsetByOverlaps(subset(instances.gr, pattern_name == "Oct4"), subset(instances.gr, pattern_name == "Oct4-Oct4"), ignore.strand = T, minoverlap = minoverlap)
oo_across_os<-subsetByOverlaps(subset(instances.gr, pattern_name == "Oct4-Oct4"), subset(instances.gr, pattern_name == "Oct4-Sox2"), ignore.strand = T, minoverlap = minoverlap)
k_across_kk<-subsetByOverlaps(subset(instances.gr, pattern_name == "Klf4"), subset(instances.gr, pattern_name == "Klf4-long"), ignore.strand = T, minoverlap = minoverlap)

#collect identifiers to remove since they are redundantly mapped across either OS or KK
redundant_instance_ids<-c(o_across_os, s_across_os, o_across_oo, oo_across_os, k_across_kk)$instance_id %>% unique

#filter distances based on redundant mapping sets.
instances.gr<-instances.gr[-redundant_instance_ids]

#Print frequency of motifs occurring before and after filtering
table(instances.gr$pattern_name)
```

## Find instance vs enhancer overlaps

```{r}
#Find overlaps
# inst_vs_enh_overlaps<-findOverlaps(instances.gr, enhancers.gr, ignore.strand = T)
inst_vs_enh_overlaps<-findOverlaps(instances.gr, resize(enhancers.gr, enh_longest, "center"), ignore.strand = T)

#Find instances and link to enhancers
instances_across_enhancers.gr<-instances.gr[inst_vs_enh_overlaps@from]
instances_across_enhancers.gr$enhancer_name<-enhancers.gr$name[inst_vs_enh_overlaps@to]

#Convert to df for plotting
instances_across_enhancers.df<-data.frame(chr = seqnames(instances_across_enhancers.gr), start = start(instances_across_enhancers.gr), end = end(instances_across_enhancers.gr), 
                                          pattern_name = instances_across_enhancers.gr$pattern_name, enhancer_name = instances_across_enhancers.gr$enhancer_name)
```

# Plot each enhancer

```{r}
#Aesthetic values
theme.size = 8
geom.text.size = theme.size * 5 / 14
motif.colors.list<-list(`Oct4-Sox2` = "#9F1D20", 
                  Oct4 = "#6d1416",
                  `Oct4-Oct4` = "#c28244", 
                  Sox2 = "#3A3C97",
                  Nanog = "#9F8A31",
                  `Nanog-alt` = "#675923",
                  Klf4 = "#357C42",
                  `Klf4-long` = "#23532c",
                  `B-box` = "#29a39f",
                  Zic3 = "#38a09d",
                  Esrrb = "#996892")

#Use instances reference of enhancer name to filter enhancers where we did not map instances across
enhancers.vec<-instances_across_enhancers.gr$enhancer_name %>% unique() 

#Generate plots
enhancers.plot.list<-mclapply(enhancers.vec, function(x){
  message(x)
  enhancer_coordinates.df<-subset(enhancers.df, enhancer_name == x)
  enhancer_coordinates.gr<-subset(enhancers.gr, enhancer_name == x)
  # dyad_coordinates.df<-subset(dyads_across_enhancers.df, enhancer_name == x)
  instance_coordinates.df<-subset(instances_across_enhancers.df, enhancer_name == x) %>% unique

  #Extract colors for enhancer
  fills_in_order<-lapply(instance_coordinates.df$pattern_name, function(x) motif.colors.list[[x]]) %>% unlist %>% unique %>% as.character #%>% lighten(., amount = .3)
  #colors_in_order<-darken(fills_in_order, amount = .6)
  motifs_in_order<-instance_coordinates.df$pattern_name %>% unique %>% as.character
  
  #Refactor
  instance_coordinates.df$pattern_name<-factor(instance_coordinates.df$pattern_name, levels = motifs_in_order)
  
  #Get half of the enhancer
  enh_half<-(enhancer_coordinates.df$mm10_end - enhancer_coordinates.df$mm10_start)/2
  
  enhancer.plot<-ggplot()+
    geom_hline(yintercept = .5, color = "gray 85")+
    geom_rect(data = enhancer_coordinates.df, aes(xmin = mm10_start, xmax = mm10_end, ymin = 0, ymax = 1), fill = "gray 85")+
    geom_text(data = enhancer_coordinates.df, aes(x = ((mm10_end - mm10_start)/2 + mm10_start), y = .5, label = mm10_coordinates_curated), color = "black", size = geom.text.size)+
    geom_rect(data = instance_coordinates.df, aes(xmin = start, xmax = end, ymin = 1.1, ymax = 2, fill = pattern_name))+
    scale_fill_manual(values = fills_in_order)+
    scale_x_continuous(breaks = seq(plyr::round_any(enhancer_coordinates.df$mm10_start - (enh_longest/2 - enh_half), 200, f = floor), 
                                    plyr::round_any(enhancer_coordinates.df$mm10_end + (enh_longest/2 - enh_half), 200, f = ceiling), 200), 
                       # minor_breaks = seq(plyr::round_any(enhancer_coordinates.df$mm10_start, 200, f = floor), 
                       #                    plyr::round_any(enhancer_coordinates.df$mm10_end, 200, f = ceiling), 200),
                       limits = c(enhancer_coordinates.df$mm10_start - (enh_longest/2 - enh_half), enhancer_coordinates.df$mm10_end + (enh_longest/2 - enh_half)))+
    scale_y_continuous(breaks = c(.5, 1.75), labels = c("Enhancer", "Motif(s)"), position = "right")+
    theme_classic()+
    theme(axis.title = element_blank(), axis.line = element_blank(), axis.ticks.y = element_blank(),
          legend.position = "none", axis.text = element_text(size = theme.size))
  
  title.plot<-ggplot()+
    geom_fit_text(data = enhancer_coordinates.df, aes(x = 0, y = 3.5/2, label = enhancer_name), 
                  reflow = TRUE, color = "black")+
    theme_classic()+
    scale_y_continuous(expand = c(0,0)) + scale_x_continuous(expand = c(0,0)) + 
    theme(axis.title = element_blank(), axis.line = element_blank(), axis.ticks = element_blank(), axis.text = element_blank(),
          legend.position = "none")  

  citation.plot<-ggplot()+
    geom_fit_text(data = enhancer_coordinates.df, aes(x = 0, y = 3.5/2, label =  strsplit(citation_shorthand, split = ";") %>% lapply(., function(x) x[1]) %>% unlist), 
                  reflow = TRUE, color = "black")+
    theme_classic()+
    scale_y_continuous(expand = c(0,0)) + scale_x_continuous(expand = c(0,0)) + 
    theme(axis.title = element_blank(), axis.line = element_blank(), axis.ticks = element_blank(), axis.text = element_blank(),
          legend.position = "none") 
  
  plot.list<-list(title.plot, citation.plot, enhancer.plot)
  grid.arrange(grobs = plot.list, widths = c(unit(1, "in"), unit(1, "in"), unit(6, "in")))
  ggsave(filename = paste0("figures/18-sfig8-enhancer-annotations/sfig8 ", x, ".pdf"), plot = grid.arrange(grobs = plot.list, widths = c(unit(1, "in"), unit(1, "in"), unit(7, "in"))), width = 8, height = .75)
  
  return(plot.list)
}, mc.cores = 10)

```

# Plot legends

For addition to figure, plot legends.

```{r}
motifs_in_order_all<-instances_across_enhancers.df$pattern_name %>% unique %>% as.character
fills_in_order_all<-lapply(instances_across_enhancers.df$pattern_name, function(x) motif.colors.list[[x]]) %>% unlist %>% unique %>% as.character #%>% lighten(., amount = .3)
motif_colors.df<-data.frame(motifs_in_order_all = motifs_in_order_all, fills_in_order_all = fills_in_order_all, stringsAsFactors = F)
motif_colors.df$pattern_name<-factor(motif_colors.df$motifs_in_order_all, levels = motifs_in_order_all)

g<-ggplot(motif_colors.df, aes(x = pattern_name, fill = pattern_name))+
  geom_tile(aes(y = 1))+
  scale_fill_manual(values = fills_in_order_all)+
  theme_classic()
ggsave("figures/18-sfig8-enhancer-annotations/sfig8_motif_legend.pdf", g)
#theme(legend.position = "none")
```

# SessionInfo

For the purposes of reproducibility, the R/Bioconductor session information is printed below:

```{r sessioninfo}
sessionInfo()
```






























